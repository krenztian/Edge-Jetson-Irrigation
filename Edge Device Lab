from fastapi import FastAPI, HTTPException
from fastapi.responses import HTMLResponse
from pydantic import BaseModel, validator
import numpy as np
import uvicorn
import logging
from datetime import datetime, timedelta  # Add timedelta here
from pathlib import Path
from typing import Optional, List
from collections import deque
from contextlib import asynccontextmanager
import requests
import json
import os

VALVE_IP = os.getenv("VALVE_IP", "10.157.111.93")  # default if env var missing

# Try to import dill, fallback to pickle
try:
    import dill as pickle
    print("Using dill for enhanced pickling capabilities")
except ImportError:
    import pickle
    print("Using standard pickle (dill not available)")

# =========================
# Logging Setup
# =========================
logging.basicConfig(level=logging.INFO, format="%(asctime)s - %(levelname)s - %(message)s")
logger = logging.getLogger(__name__)

# =========================
# Global Variables
# =========================
prediction_history = deque(maxlen=50)
cycle_data = {}
irrigation_config = {}
irrigation_history = deque(maxlen=20)

# Add this global variable near the top with other globals
manual_pump_session = {
    "active": False,
    "duration_seconds": 0,
    "start_time": None
}

# Add this after the manual_pump_session definition
unlimited_pump_session = {
    "active": False,
    "start_time": None,
    "total_runtime_seconds": 0
}

# Valve Controller Configuration
VALVE_CONTROLLER_IP = "10.157.111.93"  # Update with your Arduino's IP
VALVE_CONTROLLER_PORT = 80
valve_status = {"state": "closed", "last_updated": None, "connection_status": "disconnected"}

MODEL_DIR = Path("models")
MODEL_FILES = {
    "rf_model": MODEL_DIR / "rad_rf_model.pkl",
    "mlp_model": MODEL_DIR / "eto_mlp_model.pkl",
    "scaler_rad": MODEL_DIR / "scaler_rad.pkl",
    "scaler_eto": MODEL_DIR / "scaler_eto.pkl",
    "metadata": MODEL_DIR / "model_metadata.json",
}

models = {
    "rf_model": None,
    "mlp_model": None,
    "scaler_rad": None,
    "scaler_eto": None,
    "metadata": None,
    "loaded_at": None,
}

# =========================
# Valve Controller Communication
# =========================
class ValveController:
    def __init__(self, ip, port=80):
        self.ip = ip
        self.port = port
        self.base_url = f"http://{ip}:{port}"
    
    async def get_valve_status(self):
        """Get current valve status from Arduino controller"""
        try:
            response = requests.get(f"{self.base_url}/valve/status", timeout=5)
            if response.status_code == 200:
                data = response.json()
                valve_status["state"] = data.get("valve_state", "unknown")
                valve_status["last_updated"] = datetime.now().isoformat()
                valve_status["connection_status"] = "connected"
                return data
            else:
                valve_status["connection_status"] = "error"
                return None
        except Exception as e:
            logger.error(f"Failed to get valve status: {e}")
            valve_status["connection_status"] = "disconnected"
            return None
    
    async def open_valve(self, duration_seconds):
        """Open valve for specified duration"""
        try:
            response = requests.post(f"{self.base_url}/valve/open?duration={duration_seconds}", timeout=10)
            if response.status_code == 200:
                data = response.json()
                valve_status["state"] = "open"
                valve_status["last_updated"] = datetime.now().isoformat()
                valve_status["connection_status"] = "connected"
                logger.info(f"Valve opened for {duration_seconds} seconds")
                return data
            else:
                valve_status["connection_status"] = "error"
                return None
        except Exception as e:
            logger.error(f"Failed to open valve: {e}")
            valve_status["connection_status"] = "disconnected"
            return None
    
    async def close_valve(self):
        """Close valve immediately"""
        try:
            response = requests.get(f"{self.base_url}/valve/close", timeout=5)
            if response.status_code == 200:
                data = response.json()
                valve_status["state"] = "closed"
                valve_status["last_updated"] = datetime.now().isoformat()
                valve_status["connection_status"] = "connected"
                logger.info("Valve closed manually")
                return data
            else:
                valve_status["connection_status"] = "error"
                return None
        except Exception as e:
            logger.error(f"Failed to close valve: {e}")
            valve_status["connection_status"] = "disconnected"
            return None

# Initialize valve controller
valve_controller = ValveController(VALVE_CONTROLLER_IP, VALVE_CONTROLLER_PORT)

# =========================
# Model Loading Function
# =========================
def load_models():
    try:
        logger.info("Loading models and scalers...")
        models["rf_model"] = pickle.load(open(str(MODEL_FILES["rf_model"]), "rb"))
        models["mlp_model"] = pickle.load(open(str(MODEL_FILES["mlp_model"]), "rb"))
        models["scaler_rad"] = pickle.load(open(str(MODEL_FILES["scaler_rad"]), "rb"))
        models["scaler_eto"] = pickle.load(open(str(MODEL_FILES["scaler_eto"]), "rb"))
        models["metadata"] = json.load(open(str(MODEL_FILES["metadata"]), "r"))
        models["loaded_at"] = datetime.now().isoformat()
        logger.info("Models loaded successfully")
        
        # Set default irrigation config
        global irrigation_config
        irrigation_config = {
            "crop_type": "Durian",
            "crop_growth_stage": "Fruit growth (76-110 days)", 
            "soil_type": "Loam",
            "irrigation_type": "Sprinkler",
            "emitter_rate": 40.0,
            "plant_spacing": 10.0,
            "num_sprinklers": 2,
            "farm_name": "ESP32 Farm"
        }
        logger.info("Default irrigation config set")
        
    except Exception as e:
        logger.error(f"Failed to load models: {e}")
        raise

# =========================
# Lifespan Event Handler
# =========================
@asynccontextmanager
async def lifespan(app: FastAPI):
    # Startup
    load_models()
    # Check initial valve status
    await valve_controller.get_valve_status()
    yield
    # Shutdown - cleanup if needed
    pass

# =========================
# FastAPI App with Lifespan
# =========================
app = FastAPI(
    title="ETo Edge Computing + Smart Pump System",
    description="Real-time Evapotranspiration prediction and smart pump control with rainfall integration",
    version="4.0.0",
    lifespan=lifespan
)

# =========================
# Pydantic Models
# =========================
class WeatherInput(BaseModel):
    tmin: float
    tmax: float
    humidity: float
    wind_speed: float
    sunshine_hours: float
    rainfall_mm: float = 0.0
    device_id: str = "ESP32"
    timestamp: Optional[str] = None

    @validator('tmin', 'tmax')
    def validate_temperature(cls, v):
        if not -50 <= v <= 60:
            raise ValueError(f'Temperature {v}°C is outside realistic range (-50 to 60°C)')
        return v

    @validator('tmax')
    def validate_temp_range(cls, v, values):
        if 'tmin' in values and v < values['tmin']:
            raise ValueError('Maximum temperature cannot be less than minimum temperature')
        return v

    @validator('humidity')
    def validate_humidity(cls, v):
        if not 0 <= v <= 100:
            raise ValueError(f'Humidity {v}% must be between 0-100%')
        return v

    @validator('wind_speed')
    def validate_wind_speed(cls, v):
        if not 0 <= v <= 10.0:
            raise ValueError(f'Wind speed {v} m/s is outside expected range (0-10 m/s)')
        return v

    @validator('sunshine_hours')
    def validate_sunshine(cls, v):
        if not 0 <= v <= 24:
            raise ValueError(f'Sunshine hours {v} must be between 0-24 hours')
        return v

    @validator('rainfall_mm')
    def validate_rainfall(cls, v):
        if not 0 <= v <= 500:
            raise ValueError(f'Rainfall {v}mm is outside realistic range (0-500mm)')
        return v

class IrrigationConfig(BaseModel):
    crop_type: str = "Durian"
    crop_growth_stage: str = "Fruit growth (76-110 days)"
    soil_type: str = "Loam"
    irrigation_type: str = "Sprinkler"
    emitter_rate: float = 40.0
    plant_spacing: float = 10.0
    num_sprinklers: int = 2
    farm_name: str = "Default Farm"

class EtoPrediction(BaseModel):
    eto_mm_day: float
    estimated_rad: float
    input_data: dict
    timestamp: str
    device_id: str
    processing_time_ms: float
    model_info: dict
    validation_warnings: List[str] = []

class IrrigationRecommendation(BaseModel):
    irrigation_needed: bool
    irrigation_volume_l_per_tree: float
    eto_mm_day: float
    etc_mm_day: float
    deficit_mm: float
    RAW_threshold_mm: float
    recommendation: str
    rainfall_mm: float = 0.0
    effective_rainfall_mm: float = 0.0
    farm_config: dict
    timestamp: str

class PumpCommand(BaseModel):
    action: str  # "open" or "close"
    duration: Optional[int] = None  # Duration in seconds for "open" action

# =========================
# Enhanced Irrigation Calculator with FIXED Logic
# =========================
class IrrigationCalculator:
    def __init__(self):
        self.previous_deficit = 0
        self.yesterday_deficit = 0
        self.daily_irrigation_applied = 0
        self.last_irrigation_time = None
        self.soil_depth = 0.5 # root zone
    
    def get_swhc(self, soil_type):
        """Soil Water Holding Capacity"""
        swhc_values = {
            'Sandy Loam': 120, 
            'Loamy Sand': 80, 
            'Loam': 160, 
            'Sandy Clay Loam': 110, 
            'Clay Loam': 160
        }
        return swhc_values.get(soil_type, 160)

    def get_kc(self, crop_type, crop_growth_stage):
        """Crop coefficient values"""
        kc_values = {
            'Durian': {
                "Flowering & fruit setting (0-45 Days)": 0.5,
                "Early fruit growth (46-75 days)": 0.6,
                "Fruit growth (76-110 days)": 0.85,
                "Fruit Maturity (111-140 days)": 0.75,
                "Vegetative Growth (141-290 days)": 0.6,
                "Floral initiation (291-320 days)": 0.4,
                "Floral development (321-365 days)": 0.4
            },
            'Mangosteen': {
                "Flowering & fruit setting (0-45 Days)": 0.5,
                "Early fruit growth (46-75 days)": 0.6,
                "Fruit growth (76-110 days)": 0.8,
                "Fruit Maturity (111-140 days)": 0.7,
                "Vegetative Growth (141-290 days)": 0.6,
                "Floral initiation (291-320 days)": 0.4,
                "Floral development (321-365 days)": 0.4
            }
        }
        return kc_values.get(crop_type, {}).get(crop_growth_stage, 0.6)

    def get_wetted_diameter(self, emitter_rate):
        """Wetted diameter based on emitter rate (in meters)"""
        wetted_diameter_values = {
            20: 1.5, 30: 1.8, 35: 2.0, 40: 2.2, 50: 2.5, 58: 2.8, 70: 3.0
        }
        return wetted_diameter_values.get(int(emitter_rate), 2.0)

    def calculate_wetted_area(self, plant_spacing, emitter_rate, num_sprinklers, overlap_factor=0.8):
        """Calculate wetted area - FIXED VERSION"""
        import math
        wetted_diameter = self.get_wetted_diameter(emitter_rate)
        area_per_emitter = math.pi * (wetted_diameter / 2) ** 2
        total_wetted_area = num_sprinklers * area_per_emitter * overlap_factor
        
        # FIXED: Use full plant allocation area, not half
        tree_area_allocation = plant_spacing * plant_spacing  # 10m Ã— 10m = 100 m²
        
        return min(total_wetted_area, tree_area_allocation)

    def calculate_irrigation_volume(self, deficit_mm, wetted_area_m2, irrigation_efficiency):
        """Calculate irrigation volume based on deficit and wetted area"""
        # 1mm over 1m2 = 1 liter
        gross_volume = deficit_mm * wetted_area_m2
        required_volume = gross_volume / irrigation_efficiency
        return required_volume

    def calculate_irrigation_time(self, volume, emitter_rate, num_sprinklers):
        """Calculate irrigation time - FIXED VERSION"""
        # FIXED: Ensure we're using all sprinklers
        total_flow_rate = emitter_rate * num_sprinklers
        
        logger.info(f"Irrigation time calculation: Volume={volume:.1f}L, Rate={emitter_rate}L/h, Sprinklers={num_sprinklers}, Total={total_flow_rate}L/h")
        
        if total_flow_rate > 0:
            irrigation_time_hours = volume / total_flow_rate
            irrigation_time_seconds = int(irrigation_time_hours * 3600)
        else:
            irrigation_time_seconds = 0
        
        # Safety limit: Maximum 2 hours
        irrigation_time_seconds = min(irrigation_time_seconds, 7200)
        
        logger.info(f"Final irrigation time: {irrigation_time_seconds}s = {irrigation_time_seconds/60:.1f}min")
        
        return irrigation_time_seconds

    def calculate_effective_rainfall(self, rainfall_mm, irrigation_type="Drip"):
        """Calculate effective rainfall based on intensity"""
        if rainfall_mm <= 0:
            return 0
        
        # Effectiveness factors based on rainfall intensity
        if rainfall_mm < 5:  # Light rain
            effectiveness = 0.6
        elif rainfall_mm < 15:  # Moderate rain
            effectiveness = 0.8
        elif rainfall_mm < 30:  # Heavy rain
            effectiveness = 0.9
        else:  # Very heavy rain (runoff likely)
            effectiveness = 0.7
        
        # Adjust for irrigation type
        if irrigation_type == "Drip":
            effectiveness *= 1.05  # Slightly better capture
        
        return rainfall_mm * effectiveness

    def calculate_soil_water_balance(self, etc_today, rainfall_mm, irrigation_applied, irrigation_type):
        """Calculate updated soil water deficit with rainfall - FIXED LOGIC"""
        effective_rainfall = self.calculate_effective_rainfall(rainfall_mm, irrigation_type)
        
        # Soil water balance equation:
        water_gains = irrigation_applied + effective_rainfall
        water_losses = etc_today
        
        current_deficit = self.previous_deficit + water_losses - water_gains
        
        # FIXED: Handle heavy rain cases - if deficit becomes 0 or negative, set to 0
        if current_deficit <= 0:
            logger.info(f"Heavy rain effect: Deficit was {current_deficit:.1f}mm, setting to 0mm")
            current_deficit = 0
        
        return {
            "current_deficit": current_deficit,
            "effective_rainfall": effective_rainfall,
            "water_gains": water_gains,
            "water_losses": water_losses
        }

    def mark_irrigation_completed(self):
        """Mark that irrigation has been successfully completed"""
        self.previous_deficit = 0  # Reset deficit only after successful irrigation
        self.last_irrigation_time = datetime.now()
        logger.info("Irrigation completed - deficit reset to 0")

    def calculate_irrigation_recommendation(self, eto_mm_day, config, rainfall_mm=0.0):
        """Enhanced irrigation calculation with FIXED reset logic"""
        # Get parameters
        swhc = self.get_swhc(config.soil_type)
        wetted_area = self.calculate_wetted_area(
            config.plant_spacing, config.emitter_rate, config.num_sprinklers
        )
        
        # Calculate TAW and RAW
        soil_depth = 0.5
        taw = swhc * self.soil_depth
        mad = 0.3
        RAW = taw * mad
        
        # Calculate ETc
        kc = self.get_kc(config.crop_type, config.crop_growth_stage)
        etc = eto_mm_day * kc
        
        # Calculate soil water balance with rainfall (includes heavy rain fix)
        water_balance = self.calculate_soil_water_balance(
            etc, rainfall_mm, self.daily_irrigation_applied, config.irrigation_type
        )
        
        current_deficit = water_balance["current_deficit"]
        effective_rainfall = water_balance["effective_rainfall"]
        
        # Determine if irrigation is needed
        irrigation_efficiency = 0.9 if config.irrigation_type == "Drip" else 0.8
        
        if current_deficit >= RAW:
            # Irrigation needed
            irrigation_volume = self.calculate_irrigation_volume(
                current_deficit, wetted_area, irrigation_efficiency
            )
            
            # Calculate irrigation time
            irrigation_time_seconds = self.calculate_irrigation_time(
                irrigation_volume, config.emitter_rate, config.num_sprinklers
            )
            
            # FIXED: Don't reset deficit here - only reset after actual successful irrigation
            self.previous_deficit = current_deficit  # Keep current deficit until irrigation completes
            
            recommendation = f"Pump activation recommended: {irrigation_volume:.1f} L per tree, {irrigation_time_seconds//60} min runtime"
            irrigation_needed = True
        else:
            irrigation_volume = 0
            irrigation_time_seconds = 0
            self.daily_irrigation_applied = 0
            self.previous_deficit = current_deficit  # Carry deficit forward
            recommendation = f"No pump activation needed. Deficit: {current_deficit:.1f}mm (Threshold: {RAW:.1f}mm)"
            irrigation_needed = False
        
        return {
            "irrigation_needed": irrigation_needed,
            "irrigation_volume_l_per_tree": round(irrigation_volume, 2),
            "irrigation_time_seconds": irrigation_time_seconds,
            "eto_mm_day": round(eto_mm_day, 3),
            "etc_mm_day": round(etc, 3),
            "deficit_mm": round(current_deficit, 2),
            "RAW_threshold_mm": round(RAW, 2),
            "recommendation": recommendation,
            "rainfall_mm": round(rainfall_mm, 2),
            "effective_rainfall_mm": round(effective_rainfall, 2),
            "farm_config": {
                "crop_type": config.crop_type,
                "growth_stage": config.crop_growth_stage,
                "soil_type": config.soil_type,
                "kc": round(kc, 2),
                "wetted_area_m2": round(wetted_area, 2)
            }
        }

# Initialize irrigation calculator
irrigation_calc = IrrigationCalculator()

# =========================
# Feature Engineering Functions
# =========================
def enhance_features_for_rad(tmin, tmax, humidity, wind_speed, sunshine_hours):
    """Apply feature engineering for RAD prediction"""
    data = {
        'MIN TEMP': tmin, 'MAX TEMP': tmax, 'HUMIDITY': humidity,
        'WIND': wind_speed, 'SUN': sunshine_hours,
    }
    
    # Enhanced features
    data['TEMP_RANGE'] = tmax - tmin
    data['SOLAR_PROXY'] = sunshine_hours * (tmax / 35.0) * (1 - humidity / 100)
    data['SUN_TEMP_INTERACTION'] = sunshine_hours * tmax
    data['HUMIDITY_TEMP_RATIO'] = humidity / max(tmax, 1.0)
    
    # SUN_CATEGORY
    if sunshine_hours <= 2: data['SUN_CATEGORY'] = 0
    elif sunshine_hours <= 5: data['SUN_CATEGORY'] = 1
    elif sunshine_hours <= 8: data['SUN_CATEGORY'] = 2
    elif sunshine_hours <= 15: data['SUN_CATEGORY'] = 3
    else: data['SUN_CATEGORY'] = 4
    
    data['WIND_CLEARNESS'] = 0 if wind_speed > 5.0 else 1
    
    rad_features = [
        data['MIN TEMP'], data['MAX TEMP'], data['HUMIDITY'], 
        data['WIND'], data['SUN'], data['TEMP_RANGE'],
        data['SOLAR_PROXY'], data['SUN_TEMP_INTERACTION'],
        data['HUMIDITY_TEMP_RATIO'], data['SUN_CATEGORY'], 
        data['WIND_CLEARNESS']
    ]
    
    return np.array([rad_features])

def apply_nighttime_constraints(rad_prediction, sunshine_hours, threshold=2.5):
    """Apply nighttime constraints to RAD predictions"""
    if sunshine_hours <= threshold:
        scale = max(0.3, sunshine_hours / threshold)
        constrained_rad = rad_prediction * scale
    else:
        constrained_rad = rad_prediction
    return max(constrained_rad, 1.0)

# =========================
# Helper Function
# =========================
def fmt(value, unit=""):
    """Format numbers with 2 decimals or return N/A"""
    if isinstance(value, (int, float)):
        return f"{value:.2f}{unit}"
    return f"N/A{unit}"

# =========================
# Enhanced Prediction Endpoint with FIXED Logic
# =========================
@app.post("/predict", response_model=EtoPrediction)
async def predict_eto_endpoint(weather_data: WeatherInput):
    if not all(models[key] is not None for key in ["rf_model", "mlp_model", "scaler_rad", "scaler_eto"]):
        raise HTTPException(status_code=500, detail="Models not loaded")

    start_time = datetime.now()
    warnings = []

    try:
        # Data quality checks
        if weather_data.tmin == weather_data.tmax:
            warnings.append("Temperature min/max are identical - sensor may need calibration")
        
        if weather_data.wind_speed > 5.0:
            warnings.append(f"High wind speed ({weather_data.wind_speed} m/s) - verify sensor calibration")
        
        if weather_data.humidity > 95:
            warnings.append("Very high humidity - may affect prediction accuracy")
            
        if weather_data.rainfall_mm > 50:
            warnings.append(f"Heavy rainfall ({weather_data.rainfall_mm}mm) detected")
        
        logger.info(f"Weather data: T={weather_data.tmin}-{weather_data.tmax}°C, RH={weather_data.humidity}%, Wind={weather_data.wind_speed}m/s, Sun={weather_data.sunshine_hours}h, Rain={weather_data.rainfall_mm}mm")

        # Step 1: RAD estimation
        rad_input_enhanced = enhance_features_for_rad(
            weather_data.tmin, weather_data.tmax, weather_data.humidity,
            weather_data.wind_speed, weather_data.sunshine_hours
        )
        
        rad_scaled = models["scaler_rad"].transform(rad_input_enhanced)
        rad_prediction_raw = models["rf_model"].predict(rad_scaled)[0]
        estimated_rad = apply_nighttime_constraints(rad_prediction_raw, weather_data.sunshine_hours)

        # Step 2: ETo prediction
        eto_input = np.array([[
            weather_data.tmin, weather_data.tmax, weather_data.humidity,
            weather_data.wind_speed, weather_data.sunshine_hours, estimated_rad,
        ]])
        
        eto_scaled = models["scaler_eto"].transform(eto_input)
        eto_prediction_raw = models["mlp_model"].predict(eto_scaled)[0]
        eto_prediction = max(0.1, min(eto_prediction_raw, 15.0))

        # Step 3: Enhanced irrigation calculation with FIXED logic
        irrigation_result = None
        if irrigation_config:
            config = IrrigationConfig(**irrigation_config)
            irrigation_result = irrigation_calc.calculate_irrigation_recommendation(
                eto_prediction, config, weather_data.rainfall_mm
            )
            irrigation_result["timestamp"] = weather_data.timestamp or datetime.now().isoformat()
            irrigation_history.append(irrigation_result)
            
            # Step 4: FIXED Auto pump control - only reset deficit after successful valve operation
            if irrigation_result["irrigation_needed"] and irrigation_result["irrigation_time_seconds"] > 0:
                irrigation_time_seconds = irrigation_result["irrigation_time_seconds"]
                
                # Real valve operation
                pump_result = await valve_controller.open_valve(irrigation_time_seconds)
                if pump_result:
                    irrigation_calc.mark_irrigation_completed()  # Only reset deficit after successful operation
                    logger.info(f"Pump activated automatically for {irrigation_time_seconds} seconds")
                    warnings.append(f"Pump activated for {irrigation_time_seconds // 60} minutes")
                else:
                    warnings.append("Failed to activate pump - check valve controller connection")
            
            logger.info(f"Irrigation (with rainfall): {irrigation_result['recommendation']}")
            if weather_data.rainfall_mm > 0:
                logger.info(f"Rainfall impact: {weather_data.rainfall_mm}mm -> {irrigation_result['effective_rainfall_mm']:.1f}mm effective")

        # Get current valve status
        await valve_controller.get_valve_status()

        # Store prediction data
        processing_time = (datetime.now() - start_time).total_seconds() * 1000
        timestamp = weather_data.timestamp or datetime.now().isoformat()

        prediction_data = {
            "timestamp": timestamp,
            "device_id": weather_data.device_id,
            "input_data": {
                "tmin": weather_data.tmin,
                "tmax": weather_data.tmax,
                "temp_avg": (weather_data.tmin + weather_data.tmax) / 2,
                "humidity": weather_data.humidity,
                "wind_speed": weather_data.wind_speed,
                "sunshine_hours": weather_data.sunshine_hours,
                "rainfall_mm": weather_data.rainfall_mm,
            },
            "estimated_rad": round(float(estimated_rad), 3),
            "eto_mm_day": round(float(eto_prediction), 3),
            "processing_time_ms": round(processing_time, 2),
            "validation_warnings": warnings,
        }

        # Log rainfall data storage
        logger.info(f"Rainfall: {weather_data.rainfall_mm}mm processed")

        prediction_history.append(prediction_data)
        cycle_data.update(prediction_data)

        response = EtoPrediction(
            eto_mm_day=prediction_data["eto_mm_day"],
            estimated_rad=prediction_data["estimated_rad"],
            input_data=prediction_data["input_data"],
            timestamp=timestamp,
            device_id=weather_data.device_id,
            processing_time_ms=prediction_data["processing_time_ms"],
            validation_warnings=warnings,
            model_info={
                "trained_on": models["metadata"].get("training_date", "unknown") if models["metadata"] else "unknown",
                "eto_model_r2": models["metadata"]["performance_metrics"]["eto_model"]["test_r2"]
                if models["metadata"] and "performance_metrics" in models["metadata"] else 0,
                "rad_model_r2": models["metadata"]["performance_metrics"]["rad_model"]["test_r2"]
                if models["metadata"] and "performance_metrics" in models["metadata"] else 0,
            },
        )
        
        return response

    except ValueError as e:
        logger.error(f"Data validation error: {e}")
        raise HTTPException(status_code=422, detail=f"Data validation failed: {e}")
    except Exception as e:
        logger.error(f"Prediction failed: {e}")
        import traceback
        logger.error(f"Traceback: {traceback.format_exc()}")
        raise HTTPException(status_code=500, detail=f"Prediction error: {e}")

# =========================
# ESP32-Compatible Endpoint
# =========================
@app.post("/predict-esp32")
async def predict_eto_esp32_compatible(data: dict):
    """ESP32-compatible endpoint that handles 'rainfall' parameter name"""
    try:
        # Convert ESP32 parameter names to expected format
        converted_data = {
            "tmin": data.get("tmin"),
            "tmax": data.get("tmax"), 
            "humidity": data.get("humidity"),
            "wind_speed": data.get("wind_speed"),
            "sunshine_hours": data.get("sunshine_hours"),
            "rainfall_mm": data.get("rainfall", 0.0),  # Convert "rainfall" to "rainfall_mm"
            "device_id": data.get("device_id", "ESP32"),
            "timestamp": data.get("timestamp")
        }
        
        # Create WeatherInput object
        weather_input = WeatherInput(**converted_data)
        
        # Call the main prediction function
        return await predict_eto_endpoint(weather_input)
        
    except Exception as e:
        logger.error(f"ESP32 prediction failed: {e}")
        raise HTTPException(status_code=422, detail=f"ESP32 data conversion failed: {e}")

# =========================
# FIXED Valve Control Endpoints
# =========================
@app.post("/pump/control")
async def control_pump(command: PumpCommand):
    """Control the irrigation pump with unlimited mode support"""
    global manual_pump_session, unlimited_pump_session
    
    try:
        if command.action == "open":
            if command.duration is None:
                # UNLIMITED MODE
                unlimited_pump_session = {
                    "active": True,
                    "start_time": datetime.now(),
                    "total_runtime_seconds": 0
                }
                manual_pump_session = {"active": False, "duration_seconds": 0, "start_time": None}
                
                # Open valve indefinitely (use max duration)
                result = await valve_controller.open_valve(86400)  # 24 hours max
                
                if result:
                    return {
                        "status": "success",
                        "message": "Pump activated in unlimited mode",
                        "mode": "unlimited",
                        "valve_status": valve_status,
                        "unlimited_session": unlimited_pump_session
                    }
                else:
                    unlimited_pump_session["active"] = False
                    raise HTTPException(status_code=500, detail="Failed to activate pump")
            
            elif command.duration <= 0:
                raise HTTPException(status_code=400, detail="Duration must be positive")
            
            else:
                # TIMED MODE (existing logic)
                duration = min(command.duration, 10800)
                
                manual_pump_session = {
                    "active": True,
                    "duration_seconds": duration,
                    "start_time": datetime.now()
                }
                unlimited_pump_session = {"active": False, "start_time": None, "total_runtime_seconds": 0}
                
                result = await valve_controller.open_valve(duration)
                
                if result:
                    if irrigation_history and irrigation_history[-1].get("irrigation_needed", False):
                        irrigation_calc.mark_irrigation_completed()
                        logger.info("Manual irrigation completed - deficit reset")
                    
                    return {
                        "status": "success",
                        "message": f"Pump activated for {duration} seconds",
                        "mode": "timed",
                        "valve_status": valve_status,
                        "manual_session": manual_pump_session
                    }
                else:
                    manual_pump_session["active"] = False
                    raise HTTPException(status_code=500, detail="Failed to activate pump")
        
        elif command.action == "close":
            # Calculate summary before closing
            water_discharged = 0
            runtime_seconds = 0
            
            if unlimited_pump_session.get("active") and unlimited_pump_session.get("start_time"):
                runtime_seconds = (datetime.now() - unlimited_pump_session["start_time"]).total_seconds()
                emitter_rate = irrigation_config.get('emitter_rate', 50)
                num_sprinklers = irrigation_config.get('num_sprinklers', 2)
                total_flow_rate = emitter_rate * num_sprinklers  # L/h
                water_discharged = (total_flow_rate * runtime_seconds) / 3600  # Convert to liters
            
            # Clear sessions
            manual_pump_session = {"active": False, "duration_seconds": 0, "start_time": None}
            unlimited_pump_session["active"] = False
            
            result = await valve_controller.close_valve()
            
            if result:
                response = {
                    "status": "success", 
                    "message": "Pump deactivated",
                    "valve_status": valve_status
                }
                
                # Add summary if there was unlimited mode
                if water_discharged > 0:
                    response["summary"] = {
                        "runtime_seconds": int(runtime_seconds),
                        "runtime_minutes": round(runtime_seconds / 60, 1),
                        "water_discharged_liters": round(water_discharged, 2),
                        "emitter_rate": irrigation_config.get('emitter_rate', 0),
                        "num_sprinklers": irrigation_config.get('num_sprinklers', 0)
                    }
                
                return response
            else:
                raise HTTPException(status_code=500, detail="Failed to deactivate pump")
        
        else:
            raise HTTPException(status_code=400, detail="Invalid action. Use 'open' or 'close'")
    
    except Exception as e:
        manual_pump_session["active"] = False
        unlimited_pump_session["active"] = False
        logger.error(f"Pump control failed: {e}")
        raise HTTPException(status_code=500, detail=f"Pump control error: {e}")
        
@app.get("/pump/status")
async def get_pump_status():
    """Get current pump status"""
    await valve_controller.get_valve_status()
    return {
        "pump_status": valve_status,
        "controller_ip": VALVE_CONTROLLER_IP,
        "last_checked": datetime.now().isoformat()
    }
    
@app.get("/pump/unlimited-session")
async def get_unlimited_pump_session():
    """Get current unlimited pump session info"""
    if unlimited_pump_session.get("active") and unlimited_pump_session.get("start_time"):
        elapsed = (datetime.now() - unlimited_pump_session["start_time"]).total_seconds()
        
        # Calculate water discharged so far
        emitter_rate = irrigation_config.get('emitter_rate', 50)
        num_sprinklers = irrigation_config.get('num_sprinklers', 2)
        total_flow_rate = emitter_rate * num_sprinklers
        water_discharged = (total_flow_rate * elapsed) / 3600
        
        return {
            "active": True,
            "elapsed_seconds": int(elapsed),
            "elapsed_minutes": round(elapsed / 60, 1),
            "start_time": unlimited_pump_session["start_time"].isoformat(),
            "water_discharged_liters": round(water_discharged, 2),
            "flow_rate_lph": total_flow_rate
        }
    else:
        return {"active": False}    
        
# Add endpoint to get manual pump session info
@app.get("/pump/manual-session")
async def get_manual_pump_session():
    """Get current manual pump session info"""
    if manual_pump_session["active"] and manual_pump_session["start_time"]:
        elapsed = (datetime.now() - manual_pump_session["start_time"]).total_seconds()
        remaining = max(0, manual_pump_session["duration_seconds"] - elapsed)
        
        return {
            "active": manual_pump_session["active"],
            "duration_seconds": manual_pump_session["duration_seconds"],
            "elapsed_seconds": int(elapsed),
            "remaining_seconds": int(remaining),
            "start_time": manual_pump_session["start_time"].isoformat(),
            "auto_close_expected": manual_pump_session["start_time"] + timedelta(seconds=manual_pump_session["duration_seconds"])
        }
    else:
        return {"active": False}

@app.post("/valve/config")
async def update_valve_config(ip: str, port: int = 80):
    """Update valve controller IP configuration"""
    global valve_controller, VALVE_CONTROLLER_IP, VALVE_CONTROLLER_PORT
    
    VALVE_CONTROLLER_IP = ip
    VALVE_CONTROLLER_PORT = port
    valve_controller = ValveController(ip, port)
    
    # Test connection
    await valve_controller.get_valve_status()
    
    return {
        "status": "success",
        "message": f"Valve controller configured to {ip}:{port}",
        "connection_status": valve_status["connection_status"]
    }

# =========================
# Debug Endpoints
# =========================
@app.get("/debug/latest-data")
async def debug_latest_data():
    """Quick debug to see latest rainfall data"""
    return {
        "latest_prediction": prediction_history[-1] if prediction_history else "No predictions",
        "cycle_data": cycle_data,
        "irrigation_history_latest": irrigation_history[-1] if irrigation_history else "No irrigation data",
        "prediction_count": len(prediction_history),
        "valve_status": valve_status,
        "current_deficit": irrigation_calc.previous_deficit
    }

@app.get("/debug/rainfall")
async def debug_rainfall():
    """Debug endpoint to check rainfall data flow"""
    latest_prediction = prediction_history[-1] if prediction_history else {}
    latest_cycle = cycle_data
    latest_irrigation = irrigation_history[-1] if irrigation_history else {}
    
    debug_info = {
        "prediction_history_count": len(prediction_history),
        "latest_prediction_rainfall": latest_prediction.get("input_data", {}).get("rainfall_mm", "NOT FOUND"),
        "cycle_data_rainfall": latest_cycle.get("input_data", {}).get("rainfall_mm", "NOT FOUND") if latest_cycle else "NO CYCLE DATA",
        "latest_irrigation_rainfall": latest_irrigation.get("rainfall_mm", "NOT FOUND") if latest_irrigation else "NO IRRIGATION DATA",
        "latest_prediction_keys": list(latest_prediction.keys()) if latest_prediction else [],
        "latest_prediction_input_keys": list(latest_prediction.get("input_data", {}).keys()) if latest_prediction else [],
        "valve_status": valve_status,
        "deficit_status": {
            "current_deficit": irrigation_calc.previous_deficit,
            "last_irrigation_time": irrigation_calc.last_irrigation_time
        }
    }
    
    return debug_info
    
@app.get("/debug/manual-session")
async def debug_manual_session():
    """Debug endpoint to check manual pump session"""
    if manual_pump_session.get("active", False) and manual_pump_session.get("start_time"):
        elapsed = (datetime.now() - manual_pump_session["start_time"]).total_seconds()
        remaining = max(0, manual_pump_session["duration_seconds"] - elapsed)
        return {
            "manual_session": manual_pump_session,
            "elapsed_seconds": elapsed,
            "remaining_seconds": remaining,
            "remaining_minutes": remaining / 60,
            "pump_should_show_timer": remaining > 0
        }
    else:
        return {"manual_session": manual_pump_session, "status": "not_active"}

# =========================
# Irrigation Endpoints
# =========================
@app.post("/irrigation/config")
async def set_irrigation_config(config: IrrigationConfig):
    """Configure farm parameters for irrigation calculations"""
    global irrigation_config
    irrigation_config = config.dict()
    logger.info(f"Irrigation config updated: {config.farm_name} - {config.crop_type}")
    return {"status": "success", "message": "Irrigation configuration updated", "config": irrigation_config}

@app.get("/irrigation/config")
async def get_irrigation_config():
    """Get current irrigation configuration"""
    return irrigation_config

@app.get("/irrigation/latest")
async def get_latest_irrigation():
    """Get latest irrigation recommendation"""
    if irrigation_history:
        return irrigation_history[-1]
    return {"message": "No irrigation recommendations available"}

@app.get("/irrigation/history")
async def get_irrigation_history():
    """Get irrigation recommendation history"""
    return list(irrigation_history)

# =========================
# Rainfall Endpoints
# =========================
@app.get("/rainfall/latest")
async def get_latest_rainfall():
    """Get latest rainfall data"""
    if prediction_history:
        latest = prediction_history[-1]
        return {
            "rainfall_mm": latest.get("input_data", {}).get("rainfall_mm", 0),
            "timestamp": latest.get("timestamp"),
            "effective_rainfall": irrigation_history[-1].get("effective_rainfall_mm", 0) if irrigation_history else 0
        }
    return {"message": "No rainfall data available"}

@app.get("/rainfall/daily-total")
async def get_daily_rainfall_total():
    """Calculate total rainfall for current day"""
    today = datetime.now().date()
    daily_total = 0
    
    for pred in prediction_history:
        try:
            pred_date = datetime.fromisoformat(pred["timestamp"].replace('Z', '+00:00')).date()
            if pred_date == today:
                daily_total += pred.get("input_data", {}).get("rainfall_mm", 0)
        except:
            continue
    
    return {
        "date": today.isoformat(),
        "total_rainfall_mm": round(daily_total, 2),
        "readings_count": len([p for p in prediction_history 
                              if datetime.fromisoformat(p["timestamp"].replace('Z', '+00:00')).date() == today])
    }

# =========================
# Daily Reset Endpoint
# =========================
@app.post("/reset-daily")
async def reset_daily_tracking():
    """Reset daily tracking - call this at midnight"""
    global irrigation_calc
    irrigation_calc.previous_deficit = irrigation_calc.previous_deficit  # Carry forward current deficit
    irrigation_calc.daily_irrigation_applied = 0
    logger.info("Daily tracking reset - deficit carried forward")
    return {"status": "success", "message": "Daily tracking reset"}

# =========================
# Enhanced Dashboard with FIXED Colors and Logic
# =========================
def get_current_rainfall():
    """Get current rainfall from multiple sources"""
    sources = [
        ("cycle_data", cycle_data.get("input_data", {}).get("rainfall_mm") if cycle_data else None),
        ("latest_prediction", prediction_history[-1].get("input_data", {}).get("rainfall_mm") if prediction_history else None),
        ("latest_irrigation", irrigation_history[-1].get("rainfall_mm") if irrigation_history else None)
    ]
    
    for source_name, value in sources:
        if value is not None and value >= 0:
            return value
    
    return 0.0

@app.get("/dashboard", response_class=HTMLResponse)
async def dashboard():
    global manual_pump_session
    # Update valve status
    await valve_controller.get_valve_status()
    
    latest_data = cycle_data if cycle_data else {}
    latest_irrigation = irrigation_history[-1] if irrigation_history else {}
    
    current_rainfall = get_current_rainfall()
    
    # Prepare data for charts
    history_data = {
        'labels': [],
        'humidity': [],
        'wind_speed': [],
        'sunshine_hours': [],
        'estimated_rad': [],
        'temp_min': [],
        'temp_max': [],
        'eto_values': [],
        'etc_values': [],
        'rainfall': []
    }
    
    # Process historical data for charts
    for i, pred in enumerate(list(prediction_history)[-12:]):
        timestamp = pred.get('timestamp', '')
        if timestamp:
            try:
                dt = datetime.fromisoformat(timestamp.replace('Z', '+00:00'))
                formatted_time = dt.strftime('%H:%M')
            except:
                formatted_time = timestamp[-8:-3] if len(timestamp) > 8 else timestamp
            
            history_data['labels'].append(formatted_time)
            
            input_data = pred.get('input_data', {})
            history_data['humidity'].append(input_data.get('humidity', 0))
            history_data['wind_speed'].append(input_data.get('wind_speed', 0))
            history_data['sunshine_hours'].append(input_data.get('sunshine_hours', 0))
            history_data['estimated_rad'].append(pred.get('estimated_rad', 0))
            history_data['temp_min'].append(input_data.get('tmin', 0))
            history_data['temp_max'].append(input_data.get('tmax', 0))
            history_data['eto_values'].append(pred.get('eto_mm_day', 0))
            
            rainfall_mm = input_data.get('rainfall_mm', 0.0)
            history_data['rainfall'].append(rainfall_mm)
            
            if latest_irrigation:
                history_data['etc_values'].append(latest_irrigation.get('etc_mm_day', 0))
            else:
                history_data['etc_values'].append(0)
    
    # Current values
    current_eto = latest_data.get("eto_mm_day", 0)
    current_etc = latest_irrigation.get("etc_mm_day", 0) if latest_irrigation else 0
    current_rad = latest_data.get("estimated_rad", 0)
    current_temp_min = latest_data.get("input_data", {}).get("tmin", 0)
    current_temp_max = latest_data.get("input_data", {}).get("tmax", 0)
    current_humidity = latest_data.get("input_data", {}).get("humidity", 0)
    current_wind = latest_data.get("input_data", {}).get("wind_speed", 0)
    current_sunshine = latest_data.get("input_data", {}).get("sunshine_hours", 0)
    
    irrigation_volume = latest_irrigation.get("irrigation_volume_l_per_tree", 0)
    irrigation_needed = latest_irrigation.get("irrigation_needed", False)
    
	# Calculate irrigation running time - prioritize manual timer
    def get_irrigation_time():
	    """Get irrigation time from unlimited, manual session, or automatic recommendation"""
    
	    # Check unlimited pump session first
	    if unlimited_pump_session.get("active") and unlimited_pump_session.get("start_time"):
	        elapsed = (datetime.now() - unlimited_pump_session["start_time"]).total_seconds()
	        return -1  # Special flag for unlimited mode showing elapsed time
    
	    # Check manual pump session
	    if manual_pump_session.get("active", False) and manual_pump_session.get("start_time"):
	        elapsed = (datetime.now() - manual_pump_session["start_time"]).total_seconds()
	        remaining = max(0, manual_pump_session["duration_seconds"] - elapsed)
	        if remaining > 0:
	            return remaining / 60
	        else:
	            manual_pump_session["active"] = False
            
	    # Fall back to automatic irrigation timer
	    emitter_rate = irrigation_config.get('emitter_rate', 50)
	    num_sprinklers = irrigation_config.get('num_sprinklers', 2)
	    total_flow_rate = emitter_rate * num_sprinklers
	    automatic_time = (irrigation_volume / total_flow_rate * 60) if total_flow_rate > 0 and irrigation_volume > 0 else 0
	    return automatic_time	
		
    irrigation_time_minutes = get_irrigation_time()
    
    # FIXED PUMP STATUS COLORS
    pump_is_on = valve_status.get("state", "closed") == "open"
    manual_is_active = manual_pump_session.get("active", False)
    
    # Consider pump "on" if either Arduino reports it OR manual session is active
    pump_is_effectively_on = pump_is_on or manual_is_active
    
    if pump_is_effectively_on:
        # PUMP IS ON - GREEN
        pump_status_color = 'linear-gradient(135deg, #4caf50 0%, #388e3c 100%)'
        if manual_is_active:
            pump_status_text = 'PUMP STATUS: ON (Manual)'
        else:
            pump_status_text = 'PUMP STATUS: ON'
    else:
        # PUMP IS OFF
        if irrigation_needed:
            # OFF but needed - RED
            pump_status_color = 'linear-gradient(135deg, #ef5350 0%, #e53935 100%)'
            pump_status_text = 'PUMP ACTIVATION REQUIRED'
        else:
            # OFF and not needed - RED
            pump_status_color = 'linear-gradient(135deg, #f44336 0%, #d32f2f 100%)'
            pump_status_text = 'PUMP STATUS: OFF'
    
    pump_animation = 'pumpPulse 2s ease-in-out infinite' if pump_is_on else 'irrigationPulse 3s ease-in-out infinite' if irrigation_needed else 'none'
    
    # FIXED Water level calculation with RED for 0%
    deficit_mm = latest_irrigation.get("deficit_mm", 0)
    threshold_mm = latest_irrigation.get("RAW_threshold_mm", 100)
    
    if threshold_mm > 0:
        water_level_percent = max(0, min(100, (1 - (deficit_mm / threshold_mm)) * 100))
    else:
        water_level_percent = 100
    
    # FIXED: Make bar RED when 0%
    if water_level_percent <= 0:
        water_fill_color = '#ef5350'  # RED for 0%
    elif water_level_percent <= 30:
        water_fill_color = '#ef5350'  # RED for very low
    elif water_level_percent <= 70:
        water_fill_color = '#ffa726'  # ORANGE for medium
    else:
        water_fill_color = '#4caf50'  # GREEN for good
    
    # Replace the countdown timer section in your dashboard function with this:

    # Countdown timer section
    countdown_section = ""
    countdown_script = ""
	
    irrigation_time_value = get_irrigation_time()
    if irrigation_time_value == -1:
        irrigation_display = "∞"
    else:
        irrigation_display = f"{irrigation_time_value} minutes"
        
    if pump_is_effectively_on:
        if irrigation_time_value == -1:
            # UNLIMITED MODE - Show elapsed time
            elapsed = (datetime.now() - unlimited_pump_session["start_time"]).total_seconds()
            minutes = int(elapsed // 60)
            seconds = int(elapsed % 60)
            irrigation_display = f"{minutes}m {seconds}s (Unlimited mode)"
        
            # Calculate water discharged
            emitter_rate = irrigation_config.get('emitter_rate', 50)
            num_sprinklers = irrigation_config.get('num_sprinklers', 2)
            total_flow_rate = emitter_rate * num_sprinklers
            water_discharged = (total_flow_rate * elapsed) / 3600
        
            countdown_section = f'''
            <div class="countdown-timer unlimited-mode">
                <div class="countdown-label">UNLIMITED MODE - Running Time</div>
                <div class="countdown-time" id="countdownTime">{minutes}:{seconds:02d}</div>
                <div class="countdown-label">Water Discharged</div>
                <div class="countdown-time" id="waterDischarged">{water_discharged:.1f} L</div>
            </div>
            '''
        
            countdown_script = f'''
            let elapsedSeconds = {int(elapsed)};
            let flowRate = {total_flow_rate};  // L/h
        
            function updateUnlimitedTimer() {{
                const minutes = Math.floor(elapsedSeconds / 60);
                const seconds = elapsedSeconds % 60;
                const timeDisplay = `${{minutes}}:${{seconds.toString().padStart(2, '0')}}`;
            
                const waterLiters = (flowRate * elapsedSeconds) / 3600;
            
                const countdownElement = document.getElementById('countdownTime');
                const waterElement = document.getElementById('waterDischarged');
            
                if (countdownElement) countdownElement.textContent = timeDisplay;
                if (waterElement) waterElement.textContent = waterLiters.toFixed(1) + ' L';
            
                elapsedSeconds++;
            }}
        
            if (document.getElementById('countdownTime')) {{
                updateUnlimitedTimer();
                setInterval(updateUnlimitedTimer, 1000);
            }}
            '''
    
        elif irrigation_time_value > 0:
            # TIMED MODE (existing logic)
            remaining_seconds = irrigation_time_value * 60
            minutes = int(remaining_seconds // 60)
            seconds = int(remaining_seconds % 60)
        
            countdown_section = f'''
            <div class="countdown-timer">
                <div class="countdown-time" id="countdownTime">{minutes}:{seconds:02d}</div>
                <div class="countdown-label">Time Remaining</div>
            </div>
            '''
        
            countdown_script = f'''
            let countdownSeconds = {int(remaining_seconds)};
        
            function updateCountdown() {{
                const minutes = Math.floor(countdownSeconds / 60);
                const seconds = countdownSeconds % 60;
                const timeDisplay = `${{minutes.toString().padStart(1, '0')}}:${{seconds.toString().padStart(2, '0')}}`;
            
                const countdownElement = document.getElementById('countdownTime');
                if (countdownElement) countdownElement.textContent = timeDisplay;
            
                if (countdownSeconds > 0) {{
                    countdownSeconds--;
                }} else {{
                    if (countdownElement) countdownElement.textContent = "COMPLETE";
                    setTimeout(() => window.location.reload(), 2000);
                }}
            }}
        
            if (document.getElementById('countdownTime')) {{
                updateCountdown();
                setInterval(updateCountdown, 1000);
            }}
            '''

    html_content = f"""
    <!DOCTYPE html>
    <html>
    <head>
        <title>Smart Pump Dashboard</title>
        <meta http-equiv="refresh" content="30">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta charset="UTF-8">
        <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
        <style>
            * {{
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }}
            
            body {{
                font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                background: linear-gradient(135deg, #e3f2fd 0%, #f8f9ff 100%);
                min-height: 100vh;
                color: #2c3e50;
                line-height: 1.6;
            }}
            
            .container {{
                max-width: 1400px;
                margin: 0 auto;
                padding: 20px;
            }}
            
            .header {{
                text-align: center;
                margin-bottom: 25px;
                padding: 20px;
                background: rgba(255, 255, 255, 0.9);
                border-radius: 20px;
                backdrop-filter: blur(10px);
                box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            }}
            
            .header h1 {{
                font-size: 2rem;
                font-weight: 600;
                color: #1976D2;
                margin-bottom: 8px;
            }}
            
            .header .subtitle {{
                color: #666;
                font-size: 1rem;
            }}
            
            .nav-bar {{
                display: flex;
                justify-content: center;
                gap: 12px;
                margin-bottom: 25px;
                flex-wrap: wrap;
            }}
            
            .nav-btn {{
                padding: 8px 16px;
                background: rgba(255, 255, 255, 0.9);
                border: 1px solid rgba(25, 118, 210, 0.2);
                border-radius: 15px;
                color: #1976D2;
                text-decoration: none;
                font-weight: 500;
                font-size: 0.85rem;
                transition: all 0.3s ease;
                backdrop-filter: blur(10px);
            }}
            
            .nav-btn:hover, .nav-btn.active {{
                background: #1976D2;
                color: white;
                transform: translateY(-1px);
            }}
            
            .dashboard-main {{
                display: grid;
                grid-template-columns: 350px 1fr;
                gap: 25px;
                margin-bottom: 30px;
            }}
            
            .temp-main {{
                background: linear-gradient(135deg, #42a5f5 0%, #1976d2 100%);
                color: white;
                border-radius: 25px;
                padding: 35px;
                position: relative;
                overflow: hidden;
                display: flex;
                flex-direction: column;
                justify-content: space-between;
                min-height: 400px;
            }}
            
            .temp-main::before {{
                content: '';
                position: absolute;
                top: -50%;
                right: -50%;
                width: 200px;
                height: 200px;
                background: rgba(255, 255, 255, 0.1);
                border-radius: 50%;
            }}
            
            .location-info {{
                position: relative;
                z-index: 2;
            }}
            
            .location {{
                font-size: 1.1rem;
                font-weight: 500;
                margin-bottom: 5px;
                opacity: 0.9;
            }}
            
            .date-time {{
                font-size: 0.9rem;
                opacity: 0.7;
            }}
            
            .temp-display {{
                position: relative;
                z-index: 2;
                text-align: center;
                margin: 20px 0;
            }}
            
            .temp-current {{
                font-size: 4.5rem;
                font-weight: 300;
                margin-bottom: 10px;
            }}
            
            .temp-status {{
                font-size: 1.2rem;
                opacity: 0.9;
            }}
            
            .temp-range {{
                display: flex;
                justify-content: space-between;
                position: relative;
                z-index: 2;
                margin-top: 20px;
            }}
            
            .temp-range-item {{
                text-align: center;
            }}
            
            .temp-range-label {{
                font-size: 0.8rem;
                opacity: 0.7;
                margin-bottom: 5px;
            }}
            
            .temp-range-value {{
                font-size: 1.1rem;
                font-weight: 600;
            }}
            
            .weather-grid {{
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
                gap: 15px;
                margin-bottom: 25px;
            }}
            
            .metric-card {{
                background: rgba(255, 255, 255, 0.95);
                border-radius: 20px;
                padding: 25px;
                backdrop-filter: blur(10px);
                box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
                border: 1px solid rgba(255, 255, 255, 0.2);
                transition: transform 0.3s ease;
                position: relative;
            }}
            
            .metric-card:hover {{
                transform: translateY(-2px);
                box-shadow: 0 8px 25px rgba(0, 0, 0, 0.12);
            }}
            
            .metric-header {{
                display: flex;
                align-items: center;
                margin-bottom: 15px;
            }}
            
            .metric-icon {{
                width: 35px;
                height: 35px;
                border-radius: 10px;
                display: flex;
                align-items: center;
                justify-content: center;
                margin-right: 12px;
                font-size: 16px;
                font-weight: bold;
                color: white;
            }}
            
            .humidity-icon {{ background: #42a5f5; }}
            .wind-icon {{ background: #66bb6a; }}
            .sun-icon {{ background: #ffa726; }}
            .radiation-icon {{ background: #ef5350; }}
            .rain-icon {{ background: #2196f3; }}
            
            .metric-title {{
                font-size: 0.9rem;
                color: #666;
                font-weight: 500;
            }}
            
            .metric-value {{
                font-size: 2rem;
                font-weight: 600;
                color: #2c3e50;
                margin-bottom: 8px;
            }}
            
            .metric-unit {{
                font-size: 0.85rem;
                color: #999;
                margin-bottom: 15px;
            }}
            
            .metric-bar {{
                width: 100%;
                height: 6px;
                background: #f0f0f0;
                border-radius: 3px;
                overflow: hidden;
            }}
            
            .metric-bar-fill {{
                height: 100%;
                border-radius: 3px;
                transition: width 0.5s ease;
            }}
            
            .humidity-bar {{ background: #42a5f5; }}
            .wind-bar {{ background: #66bb6a; }}
            .sun-bar {{ background: #ffa726; }}
            .radiation-bar {{ background: #ef5350; }}
            .rain-bar {{ background: #2196f3; }}
            
            .pump-section {{
                background: {pump_status_color};
                color: white;
                border-radius: 25px;
                padding: 30px;
                margin-bottom: 30px;
                text-align: center;
                position: relative;
                animation: {pump_animation};
            }}
            
            @keyframes pumpPulse {{
                0%, 100% {{ box-shadow: 0 0 0 0 rgba(76, 175, 80, 0.4); }}
                50% {{ box-shadow: 0 0 0 15px rgba(76, 175, 80, 0); }}
            }}
            
            @keyframes irrigationPulse {{
                0%, 100% {{ box-shadow: 0 0 0 0 rgba(239, 83, 80, 0.4); }}
                50% {{ box-shadow: 0 0 0 15px rgba(239, 83, 80, 0); }}
            }}
            
            .unlimited-mode {{
				border: 2px solid rgba(255, 255, 255, 0.5);
				animation: unlimitedPulse 2s ease-in-out infinite;
			}}

			@keyframes unlimitedPulse {{
				0%, 100% {{ border-color: rgba(255, 255, 255, 0.5); }}
				50% {{ border-color: rgba(255, 255, 255, 1); }}
			}}
            
            .pump-status {{
                font-size: 2.2rem;
                font-weight: 600;
                margin-bottom: 15px;
            }}
            
            .pump-metrics {{
                display: grid;
                grid-template-columns: repeat(3, 1fr);
                gap: 25px;
                margin-top: 20px;
            }}
            
            .pump-metric {{
                text-align: center;
            }}
            
            .pump-metric-value {{
                font-size: 2.8rem;
                font-weight: 600;
                margin-bottom: 5px;
            }}
            
            .pump-metric-label {{
                font-size: 1.1rem;
                opacity: 0.8;
                font-weight: 500;
            }}
            
            .water-level-container {{
                display: flex;
                flex-direction: column;
                align-items: center;
                background: rgba(255, 255, 255, 0.15);
                border-radius: 15px;
                padding: 15px;
            }}
            
            .water-level-title {{
                font-size: 1.1rem;
                font-weight: 600;
                margin-bottom: 10px;
                opacity: 0.8;
            }}
            
            .battery-gauge {{
                display: flex;
                align-items: flex-end;
                margin-bottom: 10px;
            }}
            
            .battery-body {{
                width: 50px;
                height: 80px;
                border: 3px solid rgba(255, 255, 255, 0.8);
                border-radius: 6px;
                position: relative;
                background: rgba(255, 255, 255, 0.1);
                overflow: hidden;
                margin-right: 5px;
            }}
            
            .battery-fill {{
                position: absolute;
                bottom: 0;
                left: 0;
                right: 0;
                background: {water_fill_color};
                transition: height 0.8s ease;
                border-radius: 3px 3px 0 0;
                height: {water_level_percent}%;
            }}
            
            .battery-tip {{
                width: 15px;
                height: 6px;
                background: rgba(255, 255, 255, 0.8);
                border-radius: 0 2px 2px 0;
                margin-bottom: 35px;
            }}
            
            .water-level-labels {{
                text-align: center;
                font-size: 0.85rem;
                opacity: 0.8;
            }}
            
            .water-level-current {{
                font-weight: 600;
                margin-bottom: 2px;
            }}
            
            .water-level-threshold {{
                font-size: 0.75rem;
                opacity: 0.7;
            }}
            
            .countdown-timer {{
                background: rgba(255, 255, 255, 0.15);
                border-radius: 15px;
                padding: 20px;
                margin-top: 20px;
            }}
            
            .countdown-time {{
                font-size: 2.5rem;
                font-weight: 700;
                margin-bottom: 5px;
            }}
            
            .countdown-label {{
                font-size: 0.9rem;
                opacity: 0.9;
            }}
            
            .pump-controls {{
                display: flex;
                justify-content: center;
                gap: 15px;
                margin-top: 20px;
                flex-wrap: wrap;
            }}
            
            .pump-btn {{
                padding: 12px 25px;
                font-size: 16px;
                border: none;
                border-radius: 12px;
                cursor: pointer;
                font-weight: 600;
                transition: all 0.3s ease;
                color: white;
                background: rgba(255, 255, 255, 0.2);
                border: 2px solid rgba(255, 255, 255, 0.3);
            }}
            
            .pump-btn:hover {{
                background: rgba(255, 255, 255, 0.3);
                transform: translateY(-2px);
            }}
            
            .trends-section {{
                margin-top: 30px;
            }}
            
            .section-title {{
                font-size: 1.3rem;
                font-weight: 600;
                color: #1976D2;
                margin-bottom: 20px;
                text-align: center;
            }}
            
            .trends-grid {{
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
                gap: 20px;
            }}
            
            .trend-card {{
                background: rgba(255, 255, 255, 0.95);
                border-radius: 20px;
                padding: 25px;
                backdrop-filter: blur(10px);
                box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
                border: 1px solid rgba(255, 255, 255, 0.2);
            }}
            
            .trend-header {{
                display: flex;
                align-items: center;
                margin-bottom: 20px;
            }}
            
            .trend-icon {{
                width: 28px;
                height: 28px;
                border-radius: 8px;
                display: flex;
                align-items: center;
                justify-content: center;
                margin-right: 10px;
                font-size: 12px;
                font-weight: bold;
                color: white;
            }}
            
            .trend-title {{
                font-size: 1rem;
                font-weight: 600;
                color: #2c3e50;
            }}
            
            .chart-container {{
                position: relative;
                height: 200px;
                width: 100%;
            }}
            
            @media (max-width: 1200px) {{
                .dashboard-main {{
                    grid-template-columns: 1fr;
                }}
                
                .temp-main {{
                    min-height: 250px;
                }}
            }}
            
            @media (max-width: 768px) {{
                .container {{
                    padding: 15px;
                }}
                
                .weather-grid {{
                    grid-template-columns: repeat(2, 1fr);
                }}
                
                .pump-metrics {{
                    grid-template-columns: 1fr;
                    gap: 20px;
                }}
                
                .trends-grid {{
                    grid-template-columns: 1fr;
                }}
            }}
        </style>
    </head>
    <body>
        <div class="container">
            <div class="header">
                <h1>Smart Irrigation Control System</h1>
                <div class="subtitle">Real-time monitoring with rainfall integration & automatic pump control</div>
            </div>
            
            <div class="nav-bar">
                <a href="/dashboard" class="nav-btn active">Dashboard</a>
                <a href="/config" class="nav-btn">Settings</a>
                <a href="/irrigation/history" class="nav-btn">Raw_Data</a>
                <a href="/docs" class="nav-btn">API</a>
            </div>
            
            <div class="dashboard-main">
                <div class="temp-main">
                    <div class="location-info">
                        <div class="location" id="farmLocation">Detecting location...</div>
                        <div class="date-time">{datetime.now().strftime("Today %d %B")}</div>
                    </div>
                    
                    <div class="temp-display">
                        <div class="temp-current">{current_temp_max:.0f}°</div>
                        <div class="temp-status">Current Temperature</div>
                    </div>
                    
                    <div class="temp-range">
                        <div class="temp-range-item">
                            <div class="temp-range-label">🌡Min</div>
                            <div class="temp-range-value">{current_temp_min:.0f}°</div>
                        </div>
                        <div class="temp-range-item">
                            <div class="temp-range-label">🌡 Max</div>
                            <div class="temp-range-value">{current_temp_max:.0f}°</div>
                        </div>
                        <div class="temp-range-item">
                            <div class="temp-range-label">Range</div>
                            <div class="temp-range-value">{current_temp_max - current_temp_min:.1f}°</div>
                        </div>
                    </div>
                </div>
                
                <div>
                    <div class="weather-grid">
                        <div class="metric-card">
                            <div class="metric-header">
                                <div class="metric-icon humidity-icon">💧%</div>
                                <div class="metric-title">Humidity</div>
                            </div>
                            <div class="metric-value">{current_humidity:.0f}</div>
                            <div class="metric-unit">% relative humidity</div>
                            <div class="metric-bar">
                                <div class="metric-bar-fill humidity-bar" style="width: {current_humidity}%"></div>
                            </div>
                        </div>
                        
                        <div class="metric-card">
                            <div class="metric-header">
                                <div class="metric-icon wind-icon">🌬️</div>
                                <div class="metric-title">Wind Speed</div>
                            </div>
                            <div class="metric-value">{current_wind:.2f}</div>
                            <div class="metric-unit">m/s wind speed</div>
                            <div class="metric-bar">
                                <div class="metric-bar-fill wind-bar" style="width: {min(current_wind * 10, 100)}%"></div>
                            </div>
                        </div>
                        
                        <div class="metric-card">
                            <div class="metric-header">
                                <div class="metric-icon sun-icon">🕧</div>
                                <div class="metric-title">Sunshine Hours</div>
                            </div>
                            <div class="metric-value">{current_sunshine:.1f}</div>
                            <div class="metric-unit">hours of sunshine</div>
                            <div class="metric-bar">
                                <div class="metric-bar-fill sun-bar" style="width: {min(current_sunshine * 4.17, 100)}%"></div>
                            </div>
                        </div>
                        
                        <div class="metric-card">
                            <div class="metric-header">
                                <div class="metric-icon radiation-icon">☀️</div>
                                <div class="metric-title">Solar Radiation</div>
                            </div>
                            <div class="metric-value">{current_rad:.1f}</div>
                            <div class="metric-unit">MJ/m²/day</div>
                            <div class="metric-bar">
                                <div class="metric-bar-fill radiation-bar" style="width: {min(current_rad * 3.33, 100)}%"></div>
                            </div>
                        </div>
                        
                        <div class="metric-card">
                            <div class="metric-header">
                                <div class="metric-icon rain-icon">🌧️</div>
                                <div class="metric-title">Rainfall</div>
                            </div>
                            <div class="metric-value">{current_rainfall:.1f}</div>
                            <div class="metric-unit">mm today</div>
                            <div class="metric-bar">
                                <div class="metric-bar-fill rain-bar" style="width: {min(current_rainfall * 2, 100)}%"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="pump-section">
                <div class="pump-status">
                    {pump_status_text}
                </div>
                
                <div class="pump-metrics">
                    <div class="pump-metric">
                        <div class="pump-metric-value">{irrigation_volume:.1f}</div>
                        <div class="pump-metric-label">Liters per Tree</div>
                    </div>
                    <div class="pump-metric">
                        <div class="pump-metric-value">{irrigation_time_minutes:.0f}</div>
                        <div class="pump-metric-label">Running Time (min)</div>
                    </div>
                    <div class="pump-metric water-level-container">
                        <div class="water-level-title">Soil Water Status</div>
                        <div class="battery-gauge">
                            <div class="battery-body">
                                <div class="battery-fill"></div>
                            </div>
                            <div class="battery-tip"></div>
                        </div>
                        <div class="water-level-labels">
                            <div class="water-level-current">{water_level_percent:.0f}% Available</div>
                            <div class="water-level-threshold">Deficit: {fmt(deficit_mm, '')} mm</div>
                        </div>
                    </div>
                </div>
                
                <div class="pump-controls">
                    <button class="pump-btn" onclick="controlPump('close')">Stop Pump</button>
                    <button class="pump-btn" onclick="controlPump('open', null)">Open Pump</button>
                    <button class="pump-btn" onclick="controlPump('open', 3600)">Run 60min</button>
                    <button class="pump-btn" onclick="controlPump('open', 7200)">Run 120min</button>
                </div>
                
                {countdown_section}
            </div>
            
            <div class="trends-section">
                <div class="section-title">Historical Trends</div>
                
                <div class="trends-grid">
                    <div class="trend-card">
                        <div class="trend-header">
                            <div class="trend-icon humidity-icon">H</div>
                            <div class="trend-title">Humidity Trend</div>
                        </div>
                        <div class="chart-container">
                            <canvas id="humidityChart"></canvas>
                        </div>
                    </div>
                    
                    <div class="trend-card">
                        <div class="trend-header">
                            <div class="trend-icon wind-icon">W</div>
                            <div class="trend-title">Wind Speed Trend</div>
                        </div>
                        <div class="chart-container">
                            <canvas id="windChart"></canvas>
                        </div>
                    </div>
                    
                    <div class="trend-card">
                        <div class="trend-header">
                            <div class="trend-icon sun-icon">S</div>
                            <div class="trend-title">Sunshine Hours Trend</div>
                        </div>
                        <div class="chart-container">
                            <canvas id="sunshineChart"></canvas>
                        </div>
                    </div>
                    
                    <div class="trend-card">
                        <div class="trend-header">
                            <div class="trend-icon radiation-icon">R</div>
                            <div class="trend-title">Solar Radiation Trend</div>
                        </div>
                        <div class="chart-container">
                            <canvas id="radiationChart"></canvas>
                        </div>
                    </div>
                    
                    <div class="trend-card">
                        <div class="trend-header">
                            <div class="trend-icon rain-icon">ðŸ’§</div>
                            <div class="trend-title">Rainfall Trend</div>
                        </div>
                        <div class="chart-container">
                            <canvas id="rainfallChart"></canvas>
                        </div>
                    </div>
                    
                    <div class="trend-card">
                        <div class="trend-header">
                            <div class="trend-icon" style="background: #1976D2;">T</div>
                            <div class="trend-title">Temperature Trend</div>
                        </div>
                        <div class="chart-container">
                            <canvas id="temperatureChart"></canvas>
                        </div>
                    </div>
                    
                    <div class="trend-card">
                        <div class="trend-header">
                            <div class="trend-icon" style="background: #4CAF50;">E</div>
                            <div class="trend-title">ETc Trend</div>
                        </div>
                        <div class="chart-container">
                            <canvas id="etcChart"></canvas>
                        </div>
                    </div>
                    
                    <div class="trend-card">
                        <div class="trend-header">
                            <div class="trend-icon" style="background: #42a5f5;">O</div>
                            <div class="trend-title">ETo Trend</div>
                        </div>
                        <div class="chart-container">
                            <canvas id="etoChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <script>
            // Countdown timer
            {countdown_script}
            
            // Pump control function
            async function controlPump(action, duration = null) {{
                try {{
                    const payload = {{ action: action }};
                    if (duration !== null) payload.duration = duration;
                    
                    const response = await fetch('/pump/control', {{
                        method: 'POST',
                        headers: {{ 'Content-Type': 'application/json' }},
                        body: JSON.stringify(payload)
                    }});
                    
                    const result = await response.json();
                    
                    if (response.ok) 
                    {{
						// Show summary if available
						if (result.summary) {{
							const summary = result.summary;
							alert(
								`Pump Operation Summary:\n\n` +
								`Runtime: ${{summary.runtime_minutes}} minutes\n` +
								`Water Discharged: ${{summary.water_discharged_liters}} L per tree\n` +
								`Flow Rate: ${{summary.emitter_rate}} L/h × ${{summary.num_sprinklers}} sprinklers`
						);
						}} else {{
							alert(result.message);
						}}
						setTimeout(() => window.location.reload(), 1000);
					}} else {{
						alert('Error: ' + result.detail);
					}}
				}} catch (error) {{
					alert('Connection error: ' + error.message);
				}}
			}}
                         
            // ===== AUTO LOCATION DETECTION =====
            function detectLocation() {{
                const locElement = document.getElementById("farmLocation");
                if (!locElement) return;
            
                locElement.innerText = "Detecting location...";
            
                if (!navigator.geolocation) {{
                    locElement.innerText = "Location unavailable";
                    return;
                }} 
                navigator.geolocation.getCurrentPosition(
                    (pos) => {{
                        const lat = pos.coords.latitude.toFixed(6);
                        const lon = pos.coords.longitude.toFixed(6);
                    
                        // Reverse geocode using OpenStreetMap
                        fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${{lat}}&lon=${{lon}}`)
                            .then(res => res.json())
                            .then(data => {{
                        if (data && data.address) {{
                            // Build a nice readable line
                            const addr = data.address;
                            let locationText = "";
                    
                        if (addr.village) locationText += addr.village + ", ";
                        else if (addr.town) locationText += addr.town + ", ";
                        else if (addr.city) locationText += addr.city + ", ";

                        if (addr.state) locationText += addr.state + ", ";
                        if (addr.country) locationText += addr.country;
                    
                        locElement.innerText = locationText;
                    }} else {{
                        locElement.innerText = "Location detected";
                    }}
                }})
                .catch(() => {{
                    locElement.innerText = "Location detected (no address)";
                }});
        }},
        (err) => {{
            locElement.innerText = "Location unavailable";
            console.error(err);
        }},
        {{ enableHighAccuracy: true, timeout: 7000 }}            
    );                
}}

// Auto-run when dashboard loads
detectLocation();

            
            // Chart configurations
            const chartConfig = {{
                type: 'line',
                options: {{
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {{ legend: {{ display: false }} }},
                    scales: {{
                        x: {{
                            display: true,
                            ticks: {{ color: '#666', font: {{ size: 10 }} }},
                            grid: {{ color: 'rgba(0,0,0,0.1)' }}
                        }},
                        y: {{
                            display: true,
                            ticks: {{ color: '#666', font: {{ size: 10 }} }},
                            grid: {{ color: 'rgba(0,0,0,0.1)' }}
                        }}
                    }},
                    elements: {{
                        point: {{ radius: 3, hoverRadius: 5 }},
                        line: {{ borderWidth: 2, tension: 0.4 }}
                    }}
                }}
            }};
            
            // Initialize charts
            new Chart(document.getElementById('humidityChart').getContext('2d'), {{
                ...chartConfig,
                data: {{
                    labels: {history_data['labels']},
                    datasets: [{{
                        data: {history_data['humidity']},
                        borderColor: '#42a5f5',
                        backgroundColor: 'rgba(66, 165, 245, 0.1)',
                        fill: true
                    }}]
                }}
            }});
            
            new Chart(document.getElementById('windChart').getContext('2d'), {{
                ...chartConfig,
                data: {{
                    labels: {history_data['labels']},
                    datasets: [{{
                        data: {history_data['wind_speed']},
                        borderColor: '#66bb6a',
                        backgroundColor: 'rgba(102, 187, 106, 0.1)',
                        fill: true
                    }}]
                }}
            }});
            
            new Chart(document.getElementById('sunshineChart').getContext('2d'), {{
                ...chartConfig,
                data: {{
                    labels: {history_data['labels']},
                    datasets: [{{
                        data: {history_data['sunshine_hours']},
                        borderColor: '#ffa726',
                        backgroundColor: 'rgba(255, 167, 38, 0.1)',
                        fill: true
                    }}]
                }}
            }});
            
            new Chart(document.getElementById('radiationChart').getContext('2d'), {{
                ...chartConfig,
                data: {{
                    labels: {history_data['labels']},
                    datasets: [{{
                        data: {history_data['estimated_rad']},
                        borderColor: '#ef5350',
                        backgroundColor: 'rgba(239, 83, 80, 0.1)',
                        fill: true
                    }}]
                }}
            }});
            
            new Chart(document.getElementById('rainfallChart').getContext('2d'), {{
                ...chartConfig,
                data: {{
                    labels: {history_data['labels']},
                    datasets: [{{
                        data: {history_data['rainfall']},
                        borderColor: '#2196f3',
                        backgroundColor: 'rgba(33, 150, 243, 0.1)',
                        fill: true
                    }}]
                }}
            }});
            
            new Chart(document.getElementById('temperatureChart').getContext('2d'), {{
                ...chartConfig,
                data: {{
                    labels: {history_data['labels']},
                    datasets: [{{
                        label: 'Max Temp',
                        data: {history_data['temp_max']},
                        borderColor: '#ef5350',
                        backgroundColor: 'rgba(239, 83, 80, 0.1)',
                        fill: false
                    }}, {{
                        label: 'Min Temp',
                        data: {history_data['temp_min']},
                        borderColor: '#42a5f5',
                        backgroundColor: 'rgba(66, 165, 245, 0.1)',
                        fill: false
                    }}]
                }},
                options: {{
                    ...chartConfig.options,
                    plugins: {{ legend: {{ 
                        display: true,
                        labels: {{ color: '#666', font: {{ size: 10 }} }}
                    }} }}
                }}
            }});
            
            new Chart(document.getElementById('etcChart').getContext('2d'), {{
                ...chartConfig,
                data: {{
                    labels: {history_data['labels']},
                    datasets: [{{
                        data: {history_data['etc_values']},
                        borderColor: '#4CAF50',
                        backgroundColor: 'rgba(76, 175, 80, 0.1)',
                        fill: true
                    }}]
                }}
            }});
            
            new Chart(document.getElementById('etoChart').getContext('2d'), {{
                ...chartConfig,
                data: {{
                    labels: {history_data['labels']},
                    datasets: [{{
                        data: {history_data['eto_values']},
                        borderColor: '#42a5f5',
                        backgroundColor: 'rgba(66, 165, 245, 0.1)',
                        fill: true
                    }}]
                }}
            }});
        </script>
    </body>
    </html>
    """
    return html_content

# =========================
# Configuration Page
# =========================
@app.get("/config", response_class=HTMLResponse)
async def configuration_page():
    """Configuration interface matching dashboard theme"""
    current_config = irrigation_config
    
    def is_selected(field, value):
        return "selected" if str(current_config.get(field)) == str(value) else ""
    
    html_content = f"""
    <!DOCTYPE html>
    <html>
    <head>
        <title>Farm Configuration</title>
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta charset="UTF-8">
        <style>
            * {{
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }}
            
            body {{
                font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                background: linear-gradient(135deg, #e3f2fd 0%, #f8f9ff 100%);
                min-height: 100vh;
                color: #2c3e50;
                line-height: 1.6;
            }}
            
            .container {{
                max-width: 1000px;
                margin: 0 auto;
                padding: 20px;
            }}
            
            .header {{
                text-align: center;
                margin-bottom: 25px;
                padding: 25px 30px;
                background: rgba(255, 255, 255, 0.9);
                border-radius: 20px;
                backdrop-filter: blur(10px);
                box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            }}
            
            .header h1 {{
                font-size: 2.2rem;
                font-weight: 600;
                color: #1976D2;
                margin-bottom: 10px;
            }}
            
            .header p {{
                color: #666;
                font-size: 1rem;
            }}
            
            .nav-bar {{
                display: flex;
                justify-content: center;
                gap: 12px;
                margin-bottom: 30px;
                flex-wrap: wrap;
            }}
            
            .nav-btn {{
                padding: 8px 16px;
                background: rgba(255, 255, 255, 0.9);
                border: 1px solid rgba(25, 118, 210, 0.2);
                border-radius: 15px;
                color: #1976D2;
                text-decoration: none;
                font-weight: 500;
                font-size: 0.85rem;
                transition: all 0.3s ease;
                backdrop-filter: blur(10px);
            }}
            
            .nav-btn:hover {{
                background: #1976D2;
                color: white;
                transform: translateY(-1px);
            }}
            
            .nav-btn.active {{
                background: #1976D2;
                color: white;
            }}
            
            .current-config {{
                background: #4CAF50;
                color: white;
                padding: 25px;
                border-radius: 20px;
                margin-bottom: 25px;
                box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            }}
            
            .current-config h3 {{
                color: white;
                margin-bottom: 15px;
                font-size: 1.3rem;
                font-weight: 600;
            }}
            
            .config-preview {{
                display: grid;
                grid-template-columns: repeat(3, 1fr);
                gap: 15px;
                margin-top: 15px;
            }}
            
            .config-item {{
                background: rgba(255, 255, 255, 0.2);
                padding: 15px;
                border-radius: 10px;
                text-align: center;
            }}
            
            .config-item-label {{
                font-size: 0.8rem;
                opacity: 0.8;
                margin-bottom: 8px;
                font-weight: 500;
            }}
            
            .config-item-value {{
                font-weight: 600;
                font-size: 0.95rem;
                line-height: 1.2;
            }}
            
            .config-form {{
                background: rgba(255, 255, 255, 0.95);
                border-radius: 20px;
                padding: 30px;
                backdrop-filter: blur(10px);
                box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
                border: 1px solid rgba(255, 255, 255, 0.2);
            }}
            
            .form-section {{
                margin-bottom: 30px;
                padding: 25px;
                background: rgba(116, 185, 255, 0.05);
                border-radius: 15px;
                border-left: 4px solid #1976D2;
            }}
            
            .form-section h3 {{
                color: #1976D2;
                margin-bottom: 20px;
                font-size: 1.3rem;
                font-weight: 600;
            }}
            
            .form-grid {{
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
                gap: 20px;
            }}
            
            .form-group {{
                margin-bottom: 20px;
            }}
            
            .form-group label {{
                display: block;
                margin-bottom: 8px;
                font-weight: 600;
                color: #2c3e50;
                font-size: 0.95rem;
            }}
            
            .form-group select,
            .form-group input {{
                width: 100%;
                padding: 12px 15px;
                font-size: 14px;
                border: 2px solid #e0e0e0;
                border-radius: 10px;
                background: white;
                color: #2c3e50;
                transition: all 0.3s ease;
                font-family: inherit;
            }}
            
            .form-group select:focus,
            .form-group input:focus {{
                outline: none;
                border-color: #1976D2;
                box-shadow: 0 0 0 3px rgba(25, 118, 210, 0.1);
                transform: translateY(-1px);
            }}
            
            .form-group select:hover,
            .form-group input:hover {{
                border-color: #42a5f5;
            }}
            
            .btn-group {{
                display: flex;
                justify-content: center;
                gap: 15px;
                margin-top: 35px;
                flex-wrap: wrap;
            }}
            
            .btn {{
                padding: 12px 25px;
                font-size: 16px;
                border: none;
                border-radius: 12px;
                cursor: pointer;
                font-weight: 600;
                transition: all 0.3s ease;
                text-decoration: none;
                display: inline-block;
                font-family: inherit;
            }}
            
            .btn-primary {{
                background: #4CAF50;
                color: white;
                box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
            }}
            
            .btn-primary:hover {{
                background: #388E3C;
                transform: translateY(-2px);
                box-shadow: 0 6px 20px rgba(76, 175, 80, 0.4);
            }}
            
            .btn-secondary {{
                background: #1976D2;
                color: white;
                box-shadow: 0 4px 15px rgba(25, 118, 210, 0.3);
            }}
            
            .btn-secondary:hover {{
                background: #1565C0;
                transform: translateY(-2px);
                box-shadow: 0 6px 20px rgba(25, 118, 210, 0.4);
            }}
            
            .btn-danger {{
                background: #ef5350;
                color: white;
                box-shadow: 0 4px 15px rgba(239, 83, 80, 0.3);
            }}
            
            .btn-danger:hover {{
                background: #e53935;
                transform: translateY(-2px);
                box-shadow: 0 6px 20px rgba(239, 83, 80, 0.4);
            }}
            
            .message {{
                margin: 20px 0;
                padding: 15px 20px;
                border-radius: 12px;
                font-weight: 500;
                box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            }}
            
            .success {{
                background: #4CAF50;
                color: white;
            }}
            
            .error {{
                background: #ef5350;
                color: white;
            }}
            
            @media (max-width: 768px) {{
                .form-grid {{
                    grid-template-columns: 1fr;
                }}
                
                .btn-group {{
                    flex-direction: column;
                }}
                
                .container {{
                    padding: 15px;
                }}
                
                .config-preview {{
                    grid-template-columns: repeat(2, 1fr);
                    gap: 12px;
                }}
                
                .config-item {{
                    padding: 12px;
                }}
                
                .config-item-label {{
                    font-size: 0.75rem;
                }}
                
                .config-item-value {{
                    font-size: 0.85rem;
                }}
            }}
            
            @media (max-width: 480px) {{
                .config-preview {{
                    grid-template-columns: 1fr;
                }}
            }}
        </style>
    </head>
    <body>
        <div class="container">
            <div class="header">
                <h1>Farm Configuration</h1>
                <p>Configure your irrigation system parameters for optimal water management</p>
            </div>
            
            <div class="nav-bar">
                <a href="/dashboard" class="nav-btn">Dashboard</a>
                <a href="/config" class="nav-btn active">Settings</a>
                <a href="/irrigation/history" class="nav-btn">History</a>
                <a href="/docs" class="nav-btn">API</a>
            </div>
            
            <div class="current-config">
                <h3>Current Configuration</h3>
                <div class="config-preview">
                    <div class="config-item">
                        <div class="config-item-label">Farm Name</div>
                        <div class="config-item-value">{current_config.get('farm_name', 'Not Set')}</div>
                    </div>
                    <div class="config-item">
                        <div class="config-item-label">Crop Type</div>
                        <div class="config-item-value">{current_config.get('crop_type', 'Not Set')}</div>
                    </div>
                    <div class="config-item">
                        <div class="config-item-label">Growth Stage</div>
                        <div class="config-item-value">{current_config.get('crop_growth_stage', 'Not Set')[:15]}...</div>
                    </div>
                    <div class="config-item">
                        <div class="config-item-label">Soil Type</div>
                        <div class="config-item-value">{current_config.get('soil_type', 'Not Set')}</div>
                    </div>
                    <div class="config-item">
                        <div class="config-item-label">Irrigation Type</div>
                        <div class="config-item-value">{current_config.get('irrigation_type', 'Not Set')}</div>
                    </div>
                    <div class="config-item">
                        <div class="config-item-label">Emitter Rate</div>
                        <div class="config-item-value">{current_config.get('emitter_rate', 'Not Set')} L/h</div>
                    </div>
                    <div class="config-item">
                        <div class="config-item-label">Plant Spacing</div>
                        <div class="config-item-value">{current_config.get('plant_spacing', 'Not Set')} m</div>
                    </div>
                    <div class="config-item">
                        <div class="config-item-label">Sprinklers per Tree</div>
                        <div class="config-item-value">{current_config.get('num_sprinklers', 'Not Set')}</div>
                    </div>
                    <div class="config-item">
                        <div class="config-item-label">Efficiency</div>
                        <div class="config-item-value">{'90%' if current_config.get('irrigation_type') == 'Drip' else '80%' if current_config.get('irrigation_type') == 'Sprinkler' else 'N/A'}</div>
                    </div>
                </div>
            </div>
            
            <div class="config-form">
                <div id="message"></div>
                
                <form id="configForm">
                    <div class="form-section">
                        <h3>Farm Information</h3>
                        <div class="form-group">
                            <label for="farm_name">Farm Name:</label>
                            <input type="text" id="farm_name" value="{current_config.get('farm_name', '')}" 
                                   placeholder="Enter your farm name" required>
                        </div>
                    </div>
                    
                    <div class="form-section">
                        <h3>Crop Configuration</h3>
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="crop_type">Crop Type:</label>
                                <select id="crop_type" required>
                                    <option value="">Select Crop Type</option>
                                    <option value="Durian" {is_selected('crop_type', 'Durian')}>Durian</option>
                                    <option value="Mangosteen" {is_selected('crop_type', 'Mangosteen')}>Mangosteen</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label for="crop_growth_stage">Growth Stage:</label>
                                <select id="crop_growth_stage" required>
                                    <option value="">Select Growth Stage</option>
                                    <option value="Flowering & fruit setting (0-45 Days)" {is_selected('crop_growth_stage', 'Flowering & fruit setting (0-45 Days)')}>Flowering & fruit setting (0-45 Days)</option>
                                    <option value="Early fruit growth (46-75 days)" {is_selected('crop_growth_stage', 'Early fruit growth (46-75 days)')}>Early fruit growth (46-75 days)</option>
                                    <option value="Fruit growth (76-110 days)" {is_selected('crop_growth_stage', 'Fruit growth (76-110 days)')}>Fruit growth (76-110 days)</option>
                                    <option value="Fruit Maturity (111-140 days)" {is_selected('crop_growth_stage', 'Fruit Maturity (111-140 days)')}>Fruit Maturity (111-140 days)</option>
                                    <option value="Vegetative Growth (141-290 days)" {is_selected('crop_growth_stage', 'Vegetative Growth (141-290 days)')}>Vegetative Growth (141-290 days)</option>
                                    <option value="Floral initiation (291-320 days)" {is_selected('crop_growth_stage', 'Floral initiation (291-320 days)')}>Floral initiation (291-320 days)</option>
                                    <option value="Floral development (321-365 days)" {is_selected('crop_growth_stage', 'Floral development (321-365 days)')}>Floral development (321-365 days)</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-section">
                        <h3>Soil & Irrigation System</h3>
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="soil_type">Soil Type:</label>
                                <select id="soil_type" required>
                                    <option value="">Select Soil Type</option>
                                    <option value="Sandy Loam" {is_selected('soil_type', 'Sandy Loam')}>Sandy Loam</option>
                                    <option value="Loamy Sand" {is_selected('soil_type', 'Loamy Sand')}>Loamy Sand</option>
                                    <option value="Loam" {is_selected('soil_type', 'Loam')}>Loam</option>
                                    <option value="Sandy Clay Loam" {is_selected('soil_type', 'Sandy Clay Loam')}>Sandy Clay Loam</option>
                                    <option value="Clay Loam" {is_selected('soil_type', 'Clay Loam')}>Clay Loam</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label for="irrigation_type">Irrigation Type:</label>
                                <select id="irrigation_type" required>
                                    <option value="">Select Irrigation Type</option>
                                    <option value="Drip" {is_selected('irrigation_type', 'Drip')}>Drip (90% efficiency)</option>
                                    <option value="Sprinkler" {is_selected('irrigation_type', 'Sprinkler')}>Sprinkler (80% efficiency)</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-section">
                        <h3>Irrigation System Parameters</h3>
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="emitter_rate">Emitter Rate (L/h):</label>
                                <select id="emitter_rate" required>
                                    <option value="">Select Emitter Rate</option>
                                    <option value="20" {is_selected('emitter_rate', 20)}>20</option>
                                    <option value="30" {is_selected('emitter_rate', 30)}>30</option>
                                    <option value="35" {is_selected('emitter_rate', 35)}>35</option>
                                    <option value="40" {is_selected('emitter_rate', 40)}>40</option>
                                    <option value="50" {is_selected('emitter_rate', 50)}>50</option>
                                    <option value="58" {is_selected('emitter_rate', 58)}>58</option>
                                    <option value="70" {is_selected('emitter_rate', 70)}>70</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label for="plant_spacing">Plant Spacing (m):</label>
                                <select id="plant_spacing" required>
                                    <option value="">Select Plant Spacing</option>
                                    <option value="10" {is_selected('plant_spacing', 10)}>10</option>
                                    <option value="11" {is_selected('plant_spacing', 11)}>11</option>
                                    <option value="12" {is_selected('plant_spacing', 12)}>12</option>
                                    <option value="15" {is_selected('plant_spacing', 15)}>15</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label for="num_sprinklers">Number of Sprinklers per Tree:</label>
                                <select id="num_sprinklers" required>
                                    <option value="">Select Number</option>
                                    <option value="1" {is_selected('num_sprinklers', 1)}>1</option>
                                    <option value="2" {is_selected('num_sprinklers', 2)}>2</option>
                                    <option value="3" {is_selected('num_sprinklers', 3)}>3</option>
                                    <option value="4" {is_selected('num_sprinklers', 4)}>4</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="btn-group">
                        <button type="submit" class="btn btn-primary">Save Configuration</button>
                        <button type="button" class="btn btn-secondary" onclick="window.location.reload()">Reload Current</button>
                        <button type="button" class="btn btn-danger" onclick="resetForm()">Reset Form</button>
                    </div>
                </form>
            </div>
        </div>
        
        <script>
            document.getElementById('configForm').addEventListener('submit', async function(e) {{
                e.preventDefault();
                
                const formData = {{
                    farm_name: document.getElementById('farm_name').value,
                    crop_type: document.getElementById('crop_type').value,
                    crop_growth_stage: document.getElementById('crop_growth_stage').value,
                    soil_type: document.getElementById('soil_type').value,
                    irrigation_type: document.getElementById('irrigation_type').value,
                    emitter_rate: parseFloat(document.getElementById('emitter_rate').value),
                    plant_spacing: parseFloat(document.getElementById('plant_spacing').value),
                    num_sprinklers: parseInt(document.getElementById('num_sprinklers').value)
                }};
                
                try {{
                    const response = await fetch('/irrigation/config', {{
                        method: 'POST',
                        headers: {{ 'Content-Type': 'application/json' }},
                        body: JSON.stringify(formData)
                    }});
                    
                    const result = await response.json();
                    
                    if (response.ok) {{
                        document.getElementById('message').innerHTML = 
                            '<div class="message success">Configuration saved successfully! Redirecting to dashboard...</div>';
                        setTimeout(() => window.location.href = '/dashboard', 2000);
                    }} else {{
                        document.getElementById('message').innerHTML = 
                            '<div class="message error">Error saving configuration: ' + (result.detail || 'Unknown error') + '</div>';
                    }}
                }} catch (error) {{
                    document.getElementById('message').innerHTML = 
                        '<div class="message error">Connection error: ' + error.message + '</div>';
                }}
            }});
            
            function resetForm() {{
                if (confirm('Reset all fields to defaults?')) {{
                    document.getElementById('configForm').reset();
                }}
            }}
        
        
        
        
        
        </script>
        
    </body>
    </html>
    """
    return html_content

# =========================
# Utility Endpoints
# =========================
@app.get("/health")
async def health():
    await valve_controller.get_valve_status()
    return {
        "status": "ok", 
        "models_loaded": all(models.values()), 
        "irrigation_enabled": bool(irrigation_config),
        "valve_controller": valve_status
    }

@app.get("/model-info")
async def model_info():
    return {
        "metadata": models["metadata"],
        "loaded_at": models["loaded_at"],
        "irrigation_config": irrigation_config,
        "valve_status": valve_status,
        "feature_info": {
            "rad_features": 11,
            "eto_features": 6,
            "enhancement": "Applied in API with Rainfall Integration & Fixed Pump Control"
        }
    }

@app.post("/test-data")
async def test_esp32_data(raw_data: dict):
    """Test endpoint for ESP32 debugging"""
    logger.info(f"Raw ESP32 data received: {raw_data}")
    
    issues = []
    if "wind_speed" in raw_data:
        wind = raw_data["wind_speed"]
        if wind > 10.0:
            issues.append(f"Wind speed {wind} m/s exceeds expected range (0-10 m/s)")
    
    return {
        "received_data": raw_data,
        "issues_found": issues,
        "status": "issues_found" if issues else "data_looks_good",
        "valve_status": valve_status
    }

# =========================
# Main Execution
# =========================
if __name__ == "__main__":
    uvicorn.run("jetson2:app", host="0.0.0.0", port=8000, log_level="info", reload=False)


